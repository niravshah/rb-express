!function(e){function t(t,n,r,a){function i(t){var i=""===t?l:r(t);n.empty(),e.each(c,function(e,n){i.test(n.label)&&a(n,t)})}function o(e){return{value:e.attr("value"),label:e.text()}}var l={test:function(){return!0}},c=t.find("option").map(function(){return o(e(this))}).get();return{load:function(e,t){i(e),t&&t()},check:function(){}}}function n(t,n,r){function a(){if(!o.loading&&!o.exhausted){o.loading=!0,t.addClass("loading");var a=o.id;n(o.term,o.page,function(n){a===o.id&&(0==o.page&&t.empty(),o.page++,n&&0!==n.length||(o.exhausted=!0),e.each(n,function(e,t){r(t,o.term)}),o.loading=!1,i()||(o.callback&&o.callback(),o.callback=void 0,t.removeClass("loading")))})}}function i(){if(o.exhausted)return!1;var e=t.children(":last");if(0===e.size())return a(),!0;var n=e.offset().top-t.offset().top<t.outerHeight();return n&&a(),n}var o={id:0,term:"",page:0,loading:!1,exhausted:!1,callback:void 0};return t.scroll(i),{load:function(e,t){o={id:o.id+1,term:e,page:0,loading:!1,exhausted:!1,callback:t},a()},check:i}}function r(t){return function(){var n=[].slice.call(arguments);return this.each(function(){var r=e(this).data(t);r&&r.apply(void 0,n)})}}function a(e,t){if(e<=0)return t;var n=void 0;return function(){n&&clearTimeout(n),n=setTimeout(t,e)}}function i(t){function n(){return t.find(".current")}function r(e){return 0!==e.size()&&(n().removeClass("current"),e.addClass("current"),!0)}function a(e){return e.offset().top-t.offset().top}function i(e){var n=t.scrollTop(),r=a(e)+n;n>r&&l(r)}function o(e){var n=t.height(),r=a(e)+e.outerHeight();n<r&&l(t.scrollTop()+r-n)}function l(e){t.scrollTop(e),c=!0}var c=!1;return t.on("mouseenter","li",function(){c?c=!1:r(e(this))}),{next:function(){var e=n().next("li");r(e)&&o(e)},prev:function(){var e=n().prev("li");r(e)&&i(e)},current:n,ensure:function(){0===n().size()&&t.find("li:first").addClass("current")}}}var o={tab:9,enter:13,esc:27,left:37,up:38,right:39,down:40},l={throttle:300,renderItem:function(t,n){return void 0==t||null==t?"":"string"===e.type(t)?t:t.label?t.label:t.toString?t.toString():t},noResults:function(e){return"No results for '"+(e||"")+"'"},regexpMatcher:function(e){return new RegExp("(^|\\s)"+e,"i")}};e.fn.zelect=function(r){return r=e.extend({},l,r),this.each(function(){function l(e,t){u(m,r.renderItem(e)).removeClass("placeholder"),c(),e&&void 0!==e.value&&v.val(e.value),v.data("zelected",e),null!=t&&!0!==t||v.trigger("change",e)}function c(){g.hide(),p.removeClass("open")}function u(e,t){return e[function(e){return e instanceof jQuery||null!=e.nodeType?"html":"text"}(t)](t),e}function d(t,n){x.append(u(e("<li>").data("zelect-item",t),r.renderItem(t,n)))}function s(e){0===x.children().size()?z.html(r.noResults(e)).show():(z.hide(),b.ensure())}function f(){return e.trim(C.val())}function h(e){var t=v.find('option[selected="selected"]');if(e&&r.initial)l(r.initial);else if(!r.loader&&t.size()>0)l(x.children().eq(t.index()).data("zelect-item"));else if(r.placeholder)m.html(r.placeholder).addClass("placeholder");else{var n=x.find(":first").data("zelect-item");void 0!==n?l(n):m.html(r.noResults()).addClass("placeholder")}s()}if(0===e(this).parent().length)throw new Error("<select> element must have a parent");var v=e(this).hide().data("zelectItem",l).data("refreshItem",function(t,n){var a=function(e,t){return n(e)===n(t)};a(v.data("zelected"),t)&&(u(m,r.renderItem(t)),v.data("zelected",t));var i=f();x.find("li").each(function(){a(e(this).data("zelect-item"),t)&&u(e(this),r.renderItem(t,i)).data("zelect-item",t)})}).data("reset",function(){C.val(""),w.load("",function(){h(!1)})}),p=e("<div>").addClass("zelect"),m=e("<div>").addClass("zelected"),g=e("<div>").addClass("dropdown").hide(),z=e("<div>").addClass("no-results"),C=e("<input>").addClass("zearch"),x=e("<ol>"),b=i(x),w=r.loader?n(x,r.loader,d):t(v,x,r.regexpMatcher,d),k=a(r.throttle,function(){var e=f();w.load(e,function(){s(e)})});C.keyup(function(e){switch(e.which){case o.esc:return void c();case o.up:case o.down:return;case o.enter:var t=b.current().data("zelect-item");return void(t&&l(t));default:k()}}),C.keydown(function(e){switch(e.which){case o.tab:return e.preventDefault(),void c();case o.up:return e.preventDefault(),void b.prev();case o.down:return e.preventDefault(),void b.next()}}),x.on("click","li",function(){l(e(this).data("zelect-item"))}),p.mouseenter(function(){p.addClass("hover")}),p.mouseleave(function(){p.removeClass("hover")}),p.attr("tabindex",v.attr("tabindex")),p.blur(function(){p.hasClass("hover")||c()}),C.blur(function(){p.hasClass("hover")||c()}),m.click(function(){g.toggle(),p.toggleClass("open"),g.is(":visible")&&(C.focus().select(),w.check(),b.ensure())}),p.insertAfter(v).append(m).append(g.append(e("<div>").addClass("zearch-container").append(C).append(z)).append(x)),w.load(C.val(),function(){h(!0),v.trigger("ready")})})},e.fn.zelectItem=r("zelectItem"),e.fn.refreshZelectItem=r("refreshItem"),e.fn.resetZelect=r("reset")}(jQuery);